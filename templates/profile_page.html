{% extends "layout.html" %}

{% block title %}
    {{ user.first_name }} {{ user.last_name }}
{% endblock %}

{% block content %}
<div class="profile-page-container">
    <!-- Profile Header -->
    <div class="profile-header" 
         style="background-image: linear-gradient(to bottom, rgba(0,0,0,0) 50%, #F0F0F0 90%), url('/static/images/user_photos/profile_page_background/{{ user.profile_banner }}');">
        <div class="profile-title">
            <img src="/static/images/user_photos/profile_photos/{{ user.profile_photo }}" 
                 alt="{{ user.first_name }}'s Profile Photo" class="profile-pfp">
            <div class="profile-name">{{ user.first_name }} {{ user.last_name }}</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="profile-body">
        <!-- Your Progress Section -->
        <div class="profile-progress">
            <!-- Progress Bar -->
            <h2>Your Progress</h2>
            <div class="progress-bar-container">
                <div class="progress-bar">
                    <div class="progress-bar-fill" style="width: {{ summits_progress }}%;"></div>
                </div>
                <p class="progress-percentage">{{ summits_progress }}% Summitted</p>
            </div>
            
            <!-- Progress Details -->
            <div class="progress-details">
                <div class="progress-stat">
                    <p class="stat-title">Peaks Summitted</p>
                    <p class="stat-value">{{ peaks_summitted }}/48</p>
                </div>
                <div class="progress-stat">
                    <p class="stat-title">Days Hiked</p>
                    <p class="stat-value">{{ days_hiked }}</p>
                </div>
                <div class="progress-stat">
                    <p class="stat-title">Elevation Hiked</p>
                    <p class="stat-value">{{ elevation_hiked }} ft</p>
                </div>
                <div class="progress-stat">
                    <p class="stat-title">Last Hike</p>
                    <p class="stat-value">{{ last_hike }}</p>
                </div>
            </div>
        </div>

        <!-- Bio Section -->
        <div class="profile-bio">
            <h2>Your Bio</h2>
            <p>{{ user.bio }}</p>
        </div>

        <!-- Recent Hikes Section -->
        <div class="profile-recent-summits">
            <h2>Recent Summits</h2>
            {% if recent_summits %}
                {% for summit in recent_summits %}
                    <div class="recent-hike" onclick="openPostOverlay({{ summit.post_id }}, '{{ summit.mountain_photo }}')">
                        <img src="/static/images/mountain_images/{{ summit.mountain_photo }}" alt="{{ summit.mountain_name }}" class="recent-hike-image">
                        <div class="recent-hike-content">
                            <h3>{{ summit.mountain_name }}</h3>
                            <p>Date Hiked: {{ summit.date_hiked }}</p>
                            <p>{{ summit.notes }}</p>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p>No hikes logged.</p>
            {% endif %}
        </div>        
    </div>
</div>

<!-- Overlay Container -->
<div id="summit-overlay" class="post-overlay hidden">
    <div class="post-overlay-content">
        <!-- Left Section -->
        <div class="post-overlay-left">
            <div class="post-overlay-header">
                <img src="/static/images/user_photos/profile_photos/default.jpg" alt="Poster Profile Photo" class="post-overlay-pfp">
                <span class="post-overlay-username">Posterâ€™s Username</span>
            </div>
            <div class="post-overlay-image-container">
                <img src="/static/images/mountain_images/jefferson.jpg" alt="Post Image" class="post-overlay-post-image">
            </div>
            <div class="post-overlay-footer">
                <div class="post-overlay-likes-section">
                    <img src="/static/images/site_resources/unliked_heart.png" alt="Like" class="post-overlay-like-icon" data-post-id="">
                    <span class="post-overlay-like-count">30 Likes</span>
                </div>
                <div class="post-overlay-caption-section">
                    <p></p>
                </div>
            </div>
        </div>

        <!-- Right Section -->
        <div class="post-overlay-right">
            <div class="post-overlay-comments-section"></div>
            <div class="post-overlay-comment-input-section">
                <textarea class="post-overlay-comment-input" placeholder="Add a comment..."></textarea>
                <button class="post-overlay-comment-post-button" data-post-id="">Post</button>
            </div>
        </div>

        <!-- Close Button -->
        <button class="post-overlay-close">X</button>
    </div>
</div>

<script>
    async function openPostOverlay(post_id, mountain_photo) {
        const overlay = document.querySelector("#summit-overlay");

        try {
            // Fetch post data
            const response = await fetch(`/post-search?post_id=${encodeURIComponent(post_id)}`);
            if (!response.ok) {
                console.error("Failed to fetch post data");
                return;
            }
            const post = await response.json();

            if (post.code !== 200) {
                console.error("Post not found or error in response");
                return;
            }

            const postData = post.data;

            // Populate left section
            const posterPfp = overlay.querySelector(".post-overlay-pfp");
            const posterUsername = overlay.querySelector(".post-overlay-username");
            const postImage = overlay.querySelector(".post-overlay-post-image");
            const likeImage = overlay.querySelector(".post-overlay-like-icon");
            const likeCount = overlay.querySelector(".post-overlay-like-count");
            const captionSection = overlay.querySelector(".post-overlay-caption-section p");

            posterPfp.src = `/static/images/user_photos/profile_photos/${postData.poster.profile_photo}`;
            posterPfp.alt = `${postData.poster.username}'s Profile Photo`;
            posterUsername.textContent = postData.poster.username;
            if (!postData.picture) {
                postImage.src = `/static/images/mountain_images/${mountain_photo}`;
            } else {
                postImage.src = postData.picture;
            }
            postImage.alt = `Image of summit by ${postData.poster.username}`;
            if (postData.user_liked == 1){
                likeImage.src = "/static/images/site_resources/liked_heart.png";
            } else {
                likeImage.src = "/static/images/site_resources/unliked_heart.png";
            }
            likeImage.dataset.postId = `${post_id}`;
            likeCount.textContent = `${postData.likes} Likes`;
            captionSection.textContent = postData.caption;

            // Populate right section with comments
            const commentsSection = overlay.querySelector(".post-overlay-comments-section");
            commentsSection.innerHTML = ""; // Clear previous comments
            const commentButton = overlay.querySelector(".post-overlay-comment-post-button");
            commentButton.dataset.postId = post_id;

            postData.comments.forEach((comment) => {
                const commentDiv = document.createElement("div");
                commentDiv.classList.add("post-overlay-comment");

                commentDiv.innerHTML = `
                    <img src="/static/images/user_photos/profile_photos/${comment.profile_photo}" 
                         alt="${comment.username}'s Profile Photo" 
                         class="post-overlay-comment-pfp">
                    <div class="post-overlay-comment-content">
                        <span class="post-overlay-comment-username">${comment.username}</span>
                        <p>${comment.message}</p>
                    </div>
                `;
                commentsSection.appendChild(commentDiv);
            });

            // Show the overlay
            overlay.classList.remove("hidden");

        } catch (error) {
            console.error("Error loading post overlay:", error);
        }
    }

    // Close overlay logic
    document.querySelector(".post-overlay-close").addEventListener("click", () => {
        const overlay = document.querySelector("#summit-overlay");
        overlay.classList.add("hidden");
    });

    document.addEventListener("DOMContentLoaded", () => {
        const likeIcon = document.querySelector(".post-overlay-like-icon");
        const likeCount = document.querySelector(".post-overlay-like-count");

        likeIcon.addEventListener("click", async () => {
            const postId = likeIcon.dataset.postId; // Assuming the post ID is stored as a data attribute

            try {
                // Send POST request to toggle like
                const response = await fetch("/toggle-like", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ "post_id": postId })
                });

                const result = await response.json();
                if (result.code === 200) {
                    // Update the like count
                    likeCount.textContent = `${result.like_count} Likes`;

                    // Toggle the like icon
                    if (result.liked) {
                        likeIcon.src = "/static/images/site_resources/liked_heart.png";
                    } else {
                        likeIcon.src = "/static/images/site_resources/unliked_heart.png";
                    }
                } else {
                    console.error("Error toggling like:", result.message);
                }
            } catch (error) {
                console.error("Error:", error);
            }
        });
    });


    document.addEventListener("DOMContentLoaded", () => {
        const commentInput = document.querySelector(".post-overlay-comment-input");
        const commentButton = document.querySelector(".post-overlay-comment-post-button");
        const commentsSection = document.querySelector(".post-overlay-comments-section");

        commentButton.addEventListener("click", async () => {
            const postId = commentButton.dataset.postId; // Assuming the post ID is stored as a data attribute
            const message = commentInput.value.trim();

            if (!message) {
                alert("Comment cannot be empty.");
                return;
            }

            try {
                // Send POST request to add comment
                const response = await fetch("/post-comment", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ post_id: postId, message }),
                });

                const result = await response.json();
                if (result.code === 200) {
                    // Clear the input field
                    commentInput.value = "";

                    // Add the new comment to the comments section
                    const newComment = document.createElement("div");
                    newComment.className = "post-overlay-comment";
                    newComment.innerHTML = `
                        <img src="/static/images/user_photos/profile_photos/${result.data.profile_photo}" 
                            alt="${result.data.username}'s Profile Photo" class="post-overlay-comment-pfp">
                        <div class="post-overlay-comment-content">
                            <span class="post-overlay-comment-username">${result.data.username}</span>
                            <p>${result.data.comment}</p>
                        </div>
                    `;
                    commentsSection.appendChild(newComment);
                } else {
                    console.error("Error posting comment:", result.message);
                }
            } catch (error) {
                console.error("Error:", error);
            }
        });
    });

</script>

{% endblock %}
